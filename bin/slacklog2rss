#!/usr/bin/python
# -*- python -*-
from __future__ import print_function

from slacklog import parsers
from slacklog import formatters
from slacklog import scripts
from slacklog.scripts import u, i, main

#
#   Define and handle command line options
#
(opts, args) = main(
    description='Convert Slackware ChangeLog to RSS',
    options={
        'changelog':      {'help': 'Read input from FILE',
                           'metavar': 'FILE', 'mandatory': True},
        'encoding':       {'help': 'ChangeLog encoding [default: %default]',
                           'default': 'iso8859-1'},
        'min-date':       {'help': 'Last date to include [default: include all]',
                           'metavar': 'DATE'},
        'out':            {'help': 'Write output to FILE',
                           'metavar': 'FILE', 'mandatory': True},
        'quiet':          {'help': 'Do not print warnings',
                           'action': 'store_true'},
        'max-entries':    {'help': 'Max number of RSS entries [default: infinity]',
                           'metavar': 'NUM'},
        'slackware':      {'help': 'Slackware version [default: %default].',
                           'default': 'Slackware 13.1'},
        'rssLink':        {'help': 'Full URL of the RSS feed',
                           'metavar': 'URL', 'mandatory': True},
        'webLink':        {'help': 'Full URL of the HTML version',
                           'metavar': 'URL'},
        'description':    {'help': 'Description of the RSS feed',
                           'metavar': 'DESC'},
        'language':       {'help': 'Language of the RSS feed [default: %default]',
                           'default': 'en'},
        'managingEditor': {'help': 'EMAIL, and possibly NAME, of the editor',
                           'metavar': 'EMAIL (NAME)'},
        'webMaster':      {'help': 'EMAIL, and possibly NAME, of the web master',
                           'metavar': 'EMAIL (NAME)'}
    })

#
#   Apply options to parser and formatter
#
parsers.SlackLogParser.quiet = opts.quiet
parsers.SlackLogParser.min_date = parsers.SlackLogParser.parse_date(u(opts.min_date))

formatters.SlackLogRssFormatter.max_entries = i(opts.max_entries)
formatters.SlackLogRssFormatter.slackware = u(opts.slackware)
formatters.SlackLogRssFormatter.rssLink = u(opts.rssLink)
formatters.SlackLogRssFormatter.webLink = u(opts.webLink)
formatters.SlackLogRssFormatter.description = u(opts.description)
formatters.SlackLogRssFormatter.language = u(opts.language)
formatters.SlackLogRssFormatter.managingEditor = u(opts.managingEditor)
formatters.SlackLogRssFormatter.webMaster = u(opts.webMaster)

#
#   Read input
#
txt = scripts.read(opts.changelog, opts.encoding)

#
#   Format output
#
rss = formatters.SlackLogRssFormatter.format(parsers.SlackLogParser.parse(txt))

#
#   Write output
#
scripts.write(opts.out, rss)
